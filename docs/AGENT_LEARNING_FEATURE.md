# Agent 自我学习功能

## 功能概述

FateAgent 现在具备自我学习和性能追踪能力。系统会在比赛结束后对比 Agent 的预测与实际结果，计算准确率，并生成学习记录帮助 Agent 不断改进。

## 功能特性

### 1. 比赛结果录入
- ✅ 用户可以在比赛结束后录入实际比分
- ✅ 系统会自动检查比赛日期，确保只有已结束的比赛才能录入
- ✅ 支持通过历史记录页面的"结果对比"按钮快速访问

### 2. 预测对比分析
- ✅ **胜负预测对比**：对比 Agent 预测的胜平负结果与实际结果
- ✅ **比分预测对比**：检查实际比分是否在 Agent 的 TOP 5 预测中
- ✅ **进球数预测对比**：评估大小球和双方进球预测的准确性
- ✅ **综合评分**：基于多维度的加权评分（0-100分）

### 3. Agent 性能追踪
Agent 的性能指标包括：

#### 基础统计
- 总预测次数
- 已验证预测次数（有实际结果的）

#### 胜负预测准确率
- 总体胜负预测准确率
- 主胜判断准确率
- 平局判断准确率
- 客胜判断准确率

#### 比分预测准确率
- 精确比分命中率
- TOP 5 比分命中率

#### 进球数预测准确率
- 大小球（2.5）准确率
- 双方进球预测准确率

#### 综合评分
- 0-100 的综合评分，综合评估 Agent 的整体表现

### 4. 可视化展示
- ✅ **雷达图**：六边形雷达图展示 Agent 在各维度的能力
- ✅ **统计网格**：详细的准确率数据和进度条
- ✅ **对比卡片**：直观展示预测vs实际的对比

### 5. 学习记录
系统会自动为预测不准确的情况生成学习记录，包括：
- 错误类型（胜负错误、比分错误、置信度高估/低估）
- 错误描述
- 改进建议
- 误判因素分析

## 使用流程

### 用户端流程

1. **预测阶段**
   - 用户输入比赛信息并获得 Agent 的分析预测
   - 预测结果保存在历史记录中

2. **比赛结束后**
   - 进入「历史记录」页面
   - 对于已结束的比赛，会显示「结果对比」按钮
   - 点击按钮有两种情况：
     - 如果结果已录入：直接查看对比分析
     - 如果结果未录入：引导用户录入比赛结果

3. **录入结果**
   - 填写主队和客队的实际比分
   - 系统自动计算并保存对比数据

4. **查看分析**
   - 查看综合评分
   - 查看胜负、比分、进球数各维度的对比
   - 了解 Agent 的预测准确性

5. **查看 Agent 性能**
   - 访问「Agent 性能」页面
   - 查看雷达图和详细统计
   - 了解 Agent 的整体表现

### Agent 学习流程

1. **数据收集**
   - 每次录入结果后，系统计算预测准确性
   - 更新全局性能指标

2. **错误分析**
   - 对预测不准确的情况自动生成学习记录
   - 记录错误类型和描述

3. **性能追踪**
   - 使用增量算法更新准确率
   - 维护历史趋势数据

4. **持续改进**
   - 学习记录用于未来的模型优化
   - 性能数据指导 Prompt 和参数调整

## 技术实现

### 数据库表结构

#### analysis_records (扩展)
```sql
ALTER TABLE analysis_records
ADD COLUMN actual_result JSONB,  -- 实际结果
ADD COLUMN comparison JSONB;      -- 对比数据
```

#### agent_performance
全局性能指标表，记录 Agent 的各项准确率统计。

#### agent_learning_records
学习记录表，存储错误分析和改进建议。

### API 端点

```
POST   /api/match-results              - 录入比赛结果
GET    /api/match-results/comparison/:id  - 获取对比结果
GET    /api/agent/performance          - 获取 Agent 性能指标
```

### 评分算法

**综合评分 = 胜负预测得分(40%) + 比分预测得分(30%) + 进球数预测得分(30%)**

- **胜负预测**（满分 40）
  - 预测正确：40 分
  - 预测错误：根据置信度给予部分分数

- **比分预测**（满分 30）
  - 精确命中：30 分
  - TOP 5 命中：20 - (排名-1) × 3 分

- **进球数预测**（满分 30）
  - 大小球正确：15 分
  - 双方进球正确：15 分

### 准确率计算

使用增量更新算法：

```
新准确率 = (旧准确率 × 旧样本数 + 当前结果) / (旧样本数 + 1)
```

这样可以避免每次都重新计算所有历史数据。

## 前端页面

### 新增页面

1. **`/dashboard/comparison/[id]`** - 预测对比页面
   - 展示预测vs实际的详细对比
   - 包含综合评分、各维度准确性分析

2. **`/dashboard/record-result/[id]`** - 录入结果页面
   - 表单录入主客队比分
   - 验证和提交

3. **`/dashboard/agent-performance`** - Agent 性能页面
   - 雷达图展示各项能力
   - 详细统计数据
   - 历史趋势（待实现）

### 修改页面

1. **`/dashboard/history`** - 历史记录页面
   - 新增「结果对比」按钮
   - 只对已结束的比赛显示

### 新增组件

1. **AgentRadarChart** - 六边形雷达图
2. **AgentStatsGrid** - 统计数据网格

## 数据流程

```
用户录入结果
    ↓
计算预测对比
    ↓
├─ 更新 analysis_records.comparison
├─ 更新 agent_performance 全局指标
└─ 生成 agent_learning_records（如需要）
    ↓
用户查看对比结果
用户查看 Agent 性能
```

## 未来优化方向

### 短期（v1.1）
- [ ] Agent 自动反思功能（使用 LLM 分析错误原因）
- [ ] 性能趋势图（随时间变化）
- [ ] 置信度校准（高/中/低置信度分别统计）

### 中期（v1.2）
- [ ] 按赛事类型分类统计（世界杯、联赛等）
- [ ] 按球队分析（哪些球队预测准确率高）
- [ ] 学习记录的可视化展示

### 长期（v2.0）
- [ ] 基于学习记录自动调整 Prompt
- [ ] A/B 测试不同的预测策略
- [ ] 多 Agent 协作和对比

## 使用示例

### 示例 1：精确预测

**预测**：前进之鹰 1-2 特尔斯达（置信度 65%）
**实际**：前进之鹰 1-2 特尔斯达

**结果**：
- 胜负预测：✓ 正确（客胜）
- 比分预测：✓ 精确命中
- 综合评分：95/100

### 示例 2：胜负预测错误

**预测**：前进之鹰胜（置信度 65%）
**实际**：前进之鹰 1-2 特尔斯达（客胜）

**结果**：
- 胜负预测：✗ 错误
- 比分预测：✓ TOP 5 中（排名 #1）
- 综合评分：45/100
- 生成学习记录：分析为何误判主队实力

### 示例 3：比分预测偏差

**预测**：前进之鹰 2-1（置信度 70%）
**实际**：前进之鹰 0-3 特尔斯达

**结果**：
- 胜负预测：✗ 错误
- 比分预测：✗ 未在 TOP 5
- 综合评分：20/100
- 学习记录：需要更好分析球队近期状态和伤病影响

## 配置说明

### 数据库迁移

运行以下 SQL 脚本以添加所需的表和字段：

```bash
psql $DATABASE_URL < docs/database-migration-match-results.sql
```

### 环境变量

无需新增环境变量，使用现有的数据库连接即可。

## 注意事项

1. **比赛日期判断**：系统以本地时间 00:00:00 为界判断比赛是否结束
2. **数据准确性**：请确保录入的比分正确，错误的数据会影响 Agent 的学习
3. **性能优化**：使用增量算法，避免每次都重新计算历史数据
4. **隐私保护**：不同用户的录入数据共同贡献 Agent 的全局学习

## 相关文档

- [数据库 Schema](./database-schema.sql)
- [数据库迁移脚本](./database-migration-match-results.sql)
- [API 文档](./API.md)

## 贡献

欢迎提交 Issue 和 PR 来改进 Agent 的学习能力！
