name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    name: Claude AI Review
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            apps/**/*.{ts,tsx,js,jsx,py}
            packages/**/*.ts
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Anthropic SDK
        run: npm install @anthropic-ai/sdk
      
      - name: Run Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          node << 'EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const fs = require('fs');

          const client = new Anthropic();

          async function main() {
            const changedFiles = (process.env.CHANGED_FILES || '').split(' ').filter(f => f);
            const prTitle = process.env.PR_TITLE || '';
            const prBody = process.env.PR_BODY || '';
            
            if (changedFiles.length === 0) {
              console.log('No relevant files changed');
              fs.writeFileSync('review-result.json', JSON.stringify({ 
                decision: 'approve', 
                comment: 'Ê≤°ÊúâÈúÄË¶ÅÂÆ°Ê†∏ÁöÑ‰ª£Á†ÅÊñá‰ª∂ÂèòÊõ¥„ÄÇ' 
              }));
              return;
            }

            // Á°ÆÂÆöÂèòÊõ¥Ê∂âÂèäÂì™‰∫õÊ®°Âùó
            const modules = new Set();
            for (const file of changedFiles) {
              if (file.startsWith('apps/web/')) modules.add('frontend');
              if (file.startsWith('apps/backend/')) modules.add('backend');
              if (file.startsWith('apps/agent/')) modules.add('agent');
              if (file.startsWith('packages/')) modules.add('shared');
            }
            
            // ËØªÂèñÂèòÊõ¥ÁöÑÊñá‰ª∂ÂÜÖÂÆπ
            let fileContents = '';
            for (const file of changedFiles.slice(0, 15)) {
              try {
                const content = fs.readFileSync(file, 'utf-8');
                fileContents += `\n\n### Êñá‰ª∂: ${file}\n\`\`\`\n${content.slice(0, 4000)}\n\`\`\``;
              } catch (e) {
                console.log(`Êó†Ê≥ïËØªÂèñÊñá‰ª∂: ${file}`);
              }
            }

            // ËØªÂèñ‰ªªÂä°ËßÑÂàô
            let taskRules = '';
            try {
              if (fs.existsSync('CODEX_TASK.md')) {
                taskRules = fs.readFileSync('CODEX_TASK.md', 'utf-8');
              }
            } catch (e) {
              console.log('Êú™ÊâæÂà∞‰ªªÂä°ËßÑÂàôÊñá‰ª∂');
            }

            // ËØªÂèñÂÖ±‰∫´Á±ªÂûãÔºàÁî®‰∫éÈ™åËØÅÁ±ªÂûã‰∏ÄËá¥ÊÄßÔºâ
            let sharedTypes = '';
            try {
              if (fs.existsSync('packages/shared-types/src/api.ts')) {
                sharedTypes = fs.readFileSync('packages/shared-types/src/api.ts', 'utf-8');
              }
            } catch (e) {
              console.log('Êú™ÊâæÂà∞ÂÖ±‰∫´Á±ªÂûãÊñá‰ª∂');
            }

            const prompt = [
              '‰Ω†ÊòØ FateAgent È°πÁõÆÁöÑ‰ª£Á†ÅÂÆ°Ê†∏‰∏ìÂÆ∂„ÄÇËØ∑ÂÆ°Ê†∏‰ª•‰∏ã Pull Request„ÄÇ',
              '',
              '## PR ‰ø°ÊÅØ',
              `- Ê†áÈ¢ò: ${prTitle}`,
              `- ÊèèËø∞: ${prBody}`,
              `- Ê∂âÂèäÊ®°Âùó: ${Array.from(modules).join(', ')}`,
              '',
              '## È°πÁõÆËßÑÂàô',
              taskRules ? taskRules.slice(0, 15000) : 'ËØ∑Ê£ÄÊü•‰ª£Á†ÅË¥®Èáè„ÄÅÂÆâÂÖ®ÊÄßÂíåÊúÄ‰Ω≥ÂÆûË∑µ„ÄÇ',
              '',
              '## ÂÖ±‰∫´Á±ªÂûãÂÆö‰πâÔºàÁî®‰∫éÈ™åËØÅÂâçÂêéÁ´ØÁ±ªÂûã‰∏ÄËá¥ÊÄßÔºâ',
              '```typescript',
              sharedTypes.slice(0, 3000),
              '```',
              '',
              '## ‰ª£Á†ÅÂèòÊõ¥',
              fileContents,
              '',
              '## ÂÆ°Ê†∏Ë¶ÅÊ±Ç',
              '',
              '### 1. Á∫¢Á∫øÊ£ÄÊü•ÔºàËøùÂèç‰ªª‰∏ÄÈ°πÂøÖÈ°ª request_changesÔºâ',
              '**ÂÖ®Â±ÄÁ∫¢Á∫ø**:',
              '- ÊòØÂê¶Á°¨ÁºñÁ†Å‰∫ÜÂØÜÈí•/Âá≠ËØÅÔºü',
              '- ÊòØÂê¶Êúâ SQL ÊãºÊé•Ôºü',
              '- TypeScript ÊòØÂê¶‰ΩøÁî®‰∫Ü anyÔºü',
              '- ÂáΩÊï∞ÊòØÂê¶Ë∂ÖËøá 100 Ë°åÔºü',
              '',
              '**ÂâçÁ´ØÁ∫¢Á∫ø** (Â¶ÇÊ∂âÂèä apps/web):',
              '- ÊòØÂê¶Âú®ÁªÑ‰ª∂‰∏≠ÂÜô‰∫Ü‰∏öÂä°ÈÄªËæëÔºü',
              '- ÊòØÂê¶Á°¨ÁºñÁ†Å‰∫Ü API Âú∞ÂùÄÔºü',
              '- ÂºÇÊ≠• UI ÊòØÂê¶Â§ÑÁêÜ‰∫Ü loading/error Áä∂ÊÄÅÔºü',
              '',
              '**ÂêéÁ´ØÁ∫¢Á∫ø** (Â¶ÇÊ∂âÂèä apps/backend):',
              '- Controller ÊòØÂê¶ÂåÖÂê´‰∏öÂä°ÈÄªËæëÔºü',
              '- ÊòØÂê¶ÊúâÊú™È™åËØÅÂ∞±Êâ£ÂáèÊ¨°Êï∞ÁöÑÈÄªËæëÔºü',
              '',
              '**Agent Á∫¢Á∫ø** (Â¶ÇÊ∂âÂèä apps/agent):',
              '- ÊòØÂê¶Êèê‰æõ‰∫ÜÊäïÊ≥®Âª∫ËÆÆÔºü',
              '- ÊòØÂê¶ÁúÅÁï•‰∫ÜÂÖçË¥£Â£∞ÊòéÔºü',
              '- ÊòØÂê¶Êö¥Èú≤‰∫Ü System PromptÔºü',
              '',
              '### 2. Á±ªÂûã‰∏ÄËá¥ÊÄßÊ£ÄÊü•',
              '- ÂâçÂêéÁ´ØÊòØÂê¶‰ΩøÁî®‰∫Ü shared-types ‰∏≠ÁöÑÁ±ªÂûãÔºü',
              '- API ËØ∑Ê±Ç/ÂìçÂ∫îÊòØÂê¶‰∏éÂÖ±‰∫´Á±ªÂûã‰∏ÄËá¥Ôºü',
              '',
              '### 3. ‰ª£Á†ÅË¥®Èáè',
              '- ÊòØÂê¶ÊúâÈÄÇÂΩìÁöÑÈîôËØØÂ§ÑÁêÜÔºü',
              '- ÂëΩÂêçÊòØÂê¶Ê∏ÖÊô∞Ôºü',
              '- ÊòØÂê¶Êúâ‰∏çÂøÖË¶ÅÁöÑÂ§çÊùÇÂ∫¶Ôºü',
              '',
              '## ËæìÂá∫Ê†ºÂºèÔºàJSONÔºâ',
              '{',
              '  "decision": "approve" | "request_changes" | "comment",',
              '  "summary": "‰∏ÄÂè•ËØùÊÄªÁªì",',
              '  "redline_violations": [',
              '    {',
              '      "rule": "ËøùÂèçÁöÑÁ∫¢Á∫øËßÑÂàô",',
              '      "file": "Êñá‰ª∂Ë∑ØÂæÑ",',
              '      "line": "Ë°åÂè∑ÔºàÂèØÈÄâÔºâ",',
              '      "description": "ÂÖ∑‰ΩìÈóÆÈ¢ò"',
              '    }',
              '  ],',
              '  "issues": [',
              '    {',
              '      "severity": "critical" | "warning" | "suggestion",',
              '      "file": "Êñá‰ª∂Ë∑ØÂæÑ",',
              '      "description": "ÈóÆÈ¢òÊèèËø∞",',
              '      "suggestion": "‰øÆÊîπÂª∫ËÆÆ"',
              '    }',
              '  ],',
              '  "type_consistency": {',
              '    "passed": true | false,',
              '    "issues": ["Á±ªÂûã‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢ò"]',
              '  },',
              '  "comment": "ÁªôÂºÄÂèëËÄÖÁöÑÂÆåÊï¥ÂèçÈ¶àÔºàMarkdown Ê†ºÂºèÔºâ"',
              '}',
              '',
              '**ÈáçË¶Å**:',
              '- Â¶ÇÊûúÊúâ‰ªª‰Ωï redline_violationsÔºådecision ÂøÖÈ°ªÊòØ "request_changes"',
              '- critical Á∫ßÂà´ÈóÆÈ¢ò‰πüÂøÖÈ°ª request_changes',
              '- ÂÖ∂‰ªñÊÉÖÂÜµÂèØ‰ª• approve Êàñ comment',
            ].join('\\n');

            const response = await client.messages.create({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4096,
              messages: [{ role: 'user', content: prompt }]
            });

            const reviewText = response.content[0].text;
            
            let reviewResult;
            try {
              const jsonMatch = reviewText.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                reviewResult = JSON.parse(jsonMatch[0]);
              } else {
                reviewResult = { decision: 'comment', comment: reviewText };
              }
            } catch (e) {
              reviewResult = { decision: 'comment', comment: reviewText };
            }

            fs.writeFileSync('review-result.json', JSON.stringify(reviewResult, null, 2));
            console.log('Review completed:', reviewResult.decision);
          }

          main().catch(e => {
            console.error(e);
            process.exit(1);
          });
          EOF

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('review-result.json', 'utf-8'));
            
            let body = `## ü§ñ Claude AI ‰ª£Á†ÅÂÆ°Ê†∏\n\n`;
            
            // ÂÜ≥Á≠ñÂõæÊ†á
            const decisionIcon = {
              'approve': '‚úÖ ÈÄöËøá',
              'request_changes': '‚ùå ÈúÄË¶Å‰øÆÊîπ',
              'comment': 'üí¨ ËØÑËÆ∫'
            };
            body += `### ÂÆ°Ê†∏ÁªìÊûú: ${decisionIcon[result.decision] || result.decision}\n\n`;
            
            if (result.summary) {
              body += `**ÊÄªÁªì**: ${result.summary}\n\n`;
            }
            
            // Á∫¢Á∫øËøùËßÑÔºàÊúÄÈáçË¶ÅÔºâ
            if (result.redline_violations && result.redline_violations.length > 0) {
              body += `### üö® Á∫¢Á∫øËøùËßÑ\n\n`;
              body += `> ‚ö†Ô∏è ‰ª•‰∏ãÈóÆÈ¢ò**ÂøÖÈ°ª‰øÆÂ§ç**ÊâçËÉΩÂêàÂπ∂\n\n`;
              for (const v of result.redline_violations) {
                body += `- **${v.rule}** - \`${v.file}\`${v.line ? `:${v.line}` : ''}\n`;
                body += `  > ${v.description}\n\n`;
              }
            }
            
            // Á±ªÂûã‰∏ÄËá¥ÊÄß
            if (result.type_consistency && !result.type_consistency.passed) {
              body += `### ‚ö†Ô∏è Á±ªÂûã‰∏ÄËá¥ÊÄßÈóÆÈ¢ò\n\n`;
              for (const issue of result.type_consistency.issues || []) {
                body += `- ${issue}\n`;
              }
              body += `\n`;
            }
            
            // ÂÖ∂‰ªñÈóÆÈ¢ò
            if (result.issues && result.issues.length > 0) {
              body += `### ÂèëÁé∞ÁöÑÈóÆÈ¢ò\n\n`;
              for (const issue of result.issues) {
                const icon = issue.severity === 'critical' ? 'üö®' : 
                             issue.severity === 'warning' ? '‚ö†Ô∏è' : 'üí°';
                body += `${icon} **${issue.severity.toUpperCase()}** - \`${issue.file}\`\n`;
                body += `> ${issue.description}\n`;
                if (issue.suggestion) {
                  body += `> üí° ${issue.suggestion}\n`;
                }
                body += `\n`;
              }
            }
            
            // ËØ¶ÁªÜÂèçÈ¶à
            if (result.comment) {
              body += `### ËØ¶ÁªÜÂèçÈ¶à\n\n${result.comment}\n`;
            }
            
            // ÂèëÂ∏É Review
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: body,
              event: result.decision === 'approve' ? 'APPROVE' : 
                     result.decision === 'request_changes' ? 'REQUEST_CHANGES' : 'COMMENT'
            });
